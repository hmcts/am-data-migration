#!groovy

@Library('Infrastructure') _

properties([
    parameters([
        choice(name: 'ENVIRONMENT', choices: 'saat\nsprod\naat\nprod', description: 'Environment where migration should be run'),
        choice(name: 'SUBSCRIPTION', choices: 'sandbox\nnonprod\nprod', description: 'Azure subscriptions available to build in')
    ])
])

node {
    stage('Checkout') {
        deleteDir()
        checkout scm
    }
    stage('Run migration') {
        def DB_HOST = 'localhost'
        def DB_PORT = '5432'
        def DB_NAME = 'am'
        def DB_USER = 'amuser'
        def DB_PASS = ''

        withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId: 'am-credentials', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD']]) {
            docker.image('jbergknoff/postgresql-client').inside("--entrypoint='' -e PGPASSWORD=${DB_PASS} -v ${WORKSPACE}:/migration") {
                sh '''
                    chmod 777 /migration/ccd-to-am-migration-runner.sh
                    /migration/ccd-to-am-migration-runner.sh ${DB_HOST} ${DB_PORT} ${DB_NAME} ${DB_USER}
                    rm -rf /migration
                '''
            }
        }
    }
}
